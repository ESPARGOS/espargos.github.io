---
title: "Setup"
draft: false
type: page
layout: article

menu:
  main:
    identifier: "firmware"
    name: "Firmware"
---

<main class="flex-shrink-0">
	<div class="container">
		<div class="row py-3 cols-12">
			<h1 class="px-0">Firmware</h1>
		</div>

		<div class="row py-2 cols-12 justify-content-center">
			<div class="col mb-2 col-8 col-sm-8 col-md-3 col-lg-3 col-xl-2">
				<img src="/img/espargos-next.png" class="d-block mx-lg-auto img-fluid" alt="Photo of ESPARGOS" loading="lazy">
			</div>
			<div class="col mt-3 col-11 col-md-9 col-lg-7 col-xl-7">
				<p>
					Below, you can download the firmware for the current hardware revision of ESPARGOS (device looks as shown in picture).
					Firmware is regularly updated!
				</p>
			</div>
		</div>

		<div class="row py-4 justify-content-center pb-4">
			<div class="col col-12 col-lg-10 col-xl-9">
				<div class="border rounded-3 overflow-hidden">
					<div class="px-3 py-2 border-bottom" style="background: rgba(255,255,255,0.03);">
						<div class="d-flex justify-content-between align-items-center">
							<div class="fw-bold">Downloads</div>
						</div>
					</div>

					<div class="px-3 py-2 border-bottom">
						<div class="row g-2 align-items-center">
							<div class="col-12 col-lg-5 text-muted small">Sensor Firmware: Channels</div>
							<div class="d-none d-lg-block col-lg-2"></div>
							<div class="col-12 col-lg-5">
								<div class="row g-2 text-center">
									<div class="col-12 col-md-6">
										<div class="fw-semibold">Latest</div>
										<div class="small text-muted">{{< firmware-meta channel="latest" field="build_date" artifact="espargos-sensor-artifact.json" >}} 路 {{< firmware-meta channel="latest" field="build_version" artifact="espargos-sensor-artifact.json" >}}</div>
									</div>
									<div class="col-12 col-md-6">
										<div class="fw-semibold">Stable</div>
										<div class="small text-muted">{{< firmware-meta channel="stable" field="build_date" artifact="espargos-sensor-artifact.json" >}} 路 {{< firmware-meta channel="stable" field="build_version" artifact="espargos-sensor-artifact.json" >}}</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Sensor firmware -->
					<div class="px-3 py-3 border-bottom">
						<div class="row g-3 align-items-center">
							<div class="col-12 col-lg-5">
								<div class="d-flex align-items-center">
									<div class="me-3 flex-shrink-0">
										<img width="44" height="44" src="img/sensor-board-icon.svg" alt="Sensor board icon">
									</div>
									<div>
										<div class="fw-bold">Sensor Firmware App</div>
										<div class="text-muted small">Update first. Distributed to all sensor MCUs by the controller.</div>
									</div>
								</div>
							</div>
							<div class="d-none d-lg-block col-lg-2"></div>
							<div class="col-12 col-lg-5">
								<div class="row g-3">
									<div class="col-12 col-md-6">
										<a class="btn btn-outline-light w-100" href="latest/espargos-sensor-firmware.bin">Latest</a>
									</div>
									<div class="col-12 col-md-6">
										<a class="btn btn-outline-light w-100" href="stable/espargos-sensor-firmware.bin">Stable</a>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Sensor recovery partition -->
					<div class="px-3 py-3">
						<div class="row g-3 align-items-center">
							<div class="col-12 col-lg-5">
								<div class="d-flex align-items-center">
									<div class="me-3 flex-shrink-0">
										<img width="44" height="44" src="img/sensor-recovery-icon.svg" alt="Sensor board icon">
									</div>
									<div>
										<div class="fw-bold">Sensor Recovery Partition</div>
										<div class="text-muted small">Only needed for recovery / factory reflashing.</div>
									</div>
								</div>
							</div>
							<div class="d-none d-lg-block col-lg-2"></div>
							<div class="col-12 col-lg-5">
								<div class="row g-3">
									<div class="col-12 col-md-6">
										<a class="btn btn-outline-light w-100" href="latest/sensor-firmware-partition.bin">Latest</a>
									</div>
									<div class="col-12 col-md-6">
										<a class="btn btn-outline-light w-100" href="stable/sensor-firmware-partition.bin">Stable</a>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="px-3 py-2 border-top border-bottom">
						<div class="row g-2 align-items-center">
							<div class="col-12 col-lg-5 text-muted small">Controller Firmware: Channels</div>
							<div class="d-none d-lg-block col-lg-2"></div>
							<div class="col-12 col-lg-5">
								<div class="row g-2 text-center">
									<div class="col-12 col-md-6">
										<div class="fw-semibold">Latest</div>
										<div class="small text-muted">{{< firmware-meta channel="latest" field="build_date" artifact="espargos-controller-artifact.json" >}} 路 {{< firmware-meta channel="latest" field="build_version" artifact="espargos-controller-artifact.json" >}}</div>
									</div>
									<div class="col-12 col-md-6">
										<div class="fw-semibold">Stable</div>
										<div class="small text-muted">{{< firmware-meta channel="stable" field="build_date" artifact="espargos-controller-artifact.json" >}} 路 {{< firmware-meta channel="stable" field="build_version" artifact="espargos-controller-artifact.json" >}}</div>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Controller firmware -->
					<div class="px-3 py-3 border-bottom">
						<div class="row g-3 align-items-center">
							<div class="col-12 col-lg-5">
								<div class="d-flex align-items-center">
									<div class="me-3 flex-shrink-0">
										<img src="img/controller-icon.svg" width="44" height="44">
									</div>
									<div>
										<div class="fw-bold">Controller Firmware App</div>
										<div class="text-muted small">Update second (after sensors). Implements controller functionality.</div>
									</div>
								</div>
							</div>
							<div class="d-none d-lg-block col-lg-2"></div>
							<div class="col-12 col-lg-5">
								<div class="row g-3">
									<div class="col-12 col-md-6">
										<a class="btn btn-outline-light w-100" href="latest/espargos-controller-firmware.bin">Latest</a>
									</div>
									<div class="col-12 col-md-6">
										<a class="btn btn-outline-light w-100" href="stable/espargos-controller-firmware.bin">Stable</a>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Web assets -->
					<div class="px-3 py-3 border-bottom">
						<div class="row g-3 align-items-center">
							<div class="col-12 col-lg-5">
								<div class="d-flex align-items-center">
									<div class="me-3 flex-shrink-0">
										<img src="img/web-assets.svg" width="44" height="44">
									</div>
									<div>
										<div class="fw-bold">Web Assets</div>
										<div class="text-muted small">Update third. Contains the web UI served by the controller.</div>
									</div>
								</div>
							</div>
							<div class="d-none d-lg-block col-lg-2"></div>
							<div class="col-12 col-lg-5">
								<div class="row g-3">
									<div class="col-12 col-md-6">
										<a class="btn btn-outline-light w-100" href="latest/espargos-controller-assets.bin">Latest</a>
									</div>
									<div class="col-12 col-md-6">
										<a class="btn btn-outline-light w-100" href="stable/espargos-controller-assets.bin">Stable</a>
									</div>
								</div>
							</div>
						</div>
					</div>

					<!-- Controller recovery image -->
					<div class="px-3 py-3 border-bottom">
						<div class="row g-3 align-items-center">
							<div class="col-12 col-lg-5">
								<div class="d-flex align-items-center">
									<div class="me-3 flex-shrink-0">
										<img src="img/controller-recovery-icon.svg" width="44" height="44">
									</div>
									<div>
										<div class="fw-bold">Controller Recovery Image</div>
										<div class="text-muted small">Only needed for recovery / factory reflashing.</div>
									</div>
								</div>
							</div>
							<div class="d-none d-lg-block col-lg-2"></div>
							<div class="col-12 col-lg-5">
								<div class="row g-3">
									<div class="col-12 col-md-6">
										<a class="btn btn-outline-light w-100" href="latest/espargos-controller-recovery.bin">Latest</a>
									</div>
									<div class="col-12 col-md-6">
										<a class="btn btn-outline-light w-100" href="stable/espargos-controller-recovery.bin">Stable</a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div class="accordion" id="firmwareAccordion">
			<!-- Downloads for prototype Hardware (collapsed by default) -->
			<div class="accordion-item mb-4">
				<h2 class="accordion-header" id="headingPrototypeHardware">
					<button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePrototypeHardware" aria-expanded="false" aria-controls="collapsePrototypeHardware">
						Firmware for Prototype Hardware
					</button>
				</h2>
				<div id="collapsePrototypeHardware" class="accordion-collapse collapse" aria-labelledby="headingPrototypeHardware" data-bs-parent="#firmwareAccordion">
					<div class="accordion-body">
						<div class="row py-5 cols-12 justify-content-center">
							<div class="col col-12 col-sm-8 col-md-6 col-lg-6 col-xl-3">
								<img src="/img/pcb-render.png" class="d-block mx-lg-auto img-fluid" alt="Photo of ESPARGOS" loading="lazy">
							</div>
						</div>
						<div class="row cols-12 justify-content-center">
							<div class="col col-12 col-lg-8 col-xl-8 text-center">
								<p>
									If you still have an older prototype version of ESPARGOS, please note that this hardware is no longer supported.
									You can, however, still download the last available firmware versions for this prototype hardware below.
									Prototype firmware is not updated anymore!
								</p>
							</div>
						</div>
						<div class="row py-5 cols-12 justify-content-center">
							<div class="col col-12 col-md-4 col-lg-3 col-xl-2">
								<a class="firmware-download-button" href="prototype/espargos-sensor-firmware.bin">
									<div class="text-center fw-bold py-4">
										<div class ="mb-3">
											<img width="92" height="92" src="img/sensor-board-icon.svg">
										</div>

										Sensor Firmware
									</div>
								</a>
							</div>
							<div class="col col-12 col-md-4 col-lg-3 col-xl-2">
								<a class="firmware-download-button" href="prototype/espargos-controller-firmware.bin">
									<div class="text-center fw-bold py-4">
										<div class ="mb-3">
											<svg xmlns="http://www.w3.org/2000/svg" width="92" height="92" fill="#37c964" class="bi bi-cpu" viewBox="0 0 16 16">
												<path d="M5 0a.5.5 0 0 1 .5.5V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2h1V.5a.5.5 0 0 1 1 0V2A2.5 2.5 0 0 1 14 4.5h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14v1h1.5a.5.5 0 0 1 0 1H14a2.5 2.5 0 0 1-2.5 2.5v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14h-1v1.5a.5.5 0 0 1-1 0V14A2.5 2.5 0 0 1 2 11.5H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2v-1H.5a.5.5 0 0 1 0-1H2A2.5 2.5 0 0 1 4.5 2V.5A.5.5 0 0 1 5 0m-.5 3A1.5 1.5 0 0 0 3 4.5v7A1.5 1.5 0 0 0 4.5 13h7a1.5 1.5 0 0 0 1.5-1.5v-7A1.5 1.5 0 0 0 11.5 3zM5 6.5A1.5 1.5 0 0 1 6.5 5h3A1.5 1.5 0 0 1 11 6.5v3A1.5 1.5 0 0 1 9.5 11h-3A1.5 1.5 0 0 1 5 9.5zM6.5 6a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5z"/>
											</svg>
										</div>

										Controller Firmware
									</div>
								</a>
							</div>
							<div class="col col-12 col-md-4 col-lg-3 col-xl-2">
								<a class="firmware-download-button" href="prototype/espargos-controller-assets.bin">
									<div class="text-center fw-bold py-4">
										<div class="mb-3">
											<svg xmlns="http://www.w3.org/2000/svg" width="92" height="92" fill="#37c964" class="bi bi-cpu" viewBox="0 0 16 16">
												<path d="M3 6.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m0 3a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5m.5 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1z"/>
												<path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm12 1a1 1 0 0 1 1 1v1H1V2a1 1 0 0 1 1-1zm1 3v10a1 1 0 0 1-1 1h-2V4zm-4 0v11H2a1 1 0 0 1-1-1V4z"/>
											</svg>
										</div>

										Web Assets
									</div>
								</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<h3>Update Instructions</h3>
		<div class="alert alert-primary" role="alert"><b>Important:</b> Always update ALL firmware components of your ESPARGOS device and update them in this order: First sensor firmware, then controller firmware, then web assets.</div>

		<h5>Web Browser</h5>
		<div class="row justify-content-md-center">
			<img class="col col-12 col-md-12 col-lg-8, col-xl-6 screenshot" src="img/fwupdate-browser.png" class="screenshot">
		</div>
		<div class="px-1 py-3">
			<ul>
				<li>Go to the web interface of your ESPARGOS device. See <a href="/setup">Setup</a> to learn how.</li>
				<li>
					One after the other, select and flash the firmware files for
					<ul>
						<li>sensor firmware,</li>
						<li>controller firmware and</li>
						<li>controller web assets.</li>
					</ul>
					ESPARGOS will reboot after every firmware update.
				</li>
			</ul>
		</div>

		<h5>Command Line</h5>
		<div class="p-2">
			<pre class="m-0"><code class="language-bash" style="background: black;"># Download latest firmware files from espargos.net
cd /tmp
wget https://espargos.net/firmware/latest/espargos-sensor-firmware.bin
wget https://espargos.net/firmware/latest/espargos-controller-firmware.bin
wget https://espargos.net/firmware/latest/espargos-controller-assets.bin

# Upload firmware to ESPARGOS:
# * Change ESPARGOS_HOST to the IP address / hostname of your ESPARGOS device.
# * Make sure the update succeeded after every step. Otherwise, reboot ESPARGOS.
ESPARGOS_HOST=192.168.1.2
curl -# "http://$ESPARGOS_HOST/update_sensor_firmware" --compressed -H "Content-Type: application/octet-stream" --data-binary @espargos-sensor-firmware.bin | tee /dev/null
curl -# "http://$ESPARGOS_HOST/update_firmware" --compressed -H "Content-Type: application/octet-stream" --data-binary @espargos-controller-firmware.bin | tee /dev/null
curl -# "http://$ESPARGOS_HOST/update_assets" --compressed -H "Content-Type: application/octet-stream" --data-binary @espargos-controller-assets.bin | tee /dev/null</pre></code>
	</div>
	<script>hljs.highlightAll();</script>


	<h2 class="mt-4">Sensor Update Behavior</h2>
		<div class="row cols-12 justify-content-md-center">
			<div class="col col-12 col-lg-8 col-xl-5 text-center">
				<img id="espargos-sensorupdate" src="../setup/lowres/espargos-render-sensors-red.png" style="width: 100%; transform: scale(1.2);">
				<script type="text/javascript">
					const sensorupdate_sequence = [
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green-and-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green-and-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green-and-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green-and-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green-and-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green-and-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green-and-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green-and-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green-and-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render-sensors-green-and-red.png"
						},
						{
							"duration" : 300,
							"image" : "../setup/lowres/espargos-render.png"
						}
					];
	
					do_blink(sensorupdate_sequence, "espargos-sensorupdate");
				</script>
			</div>
			<div class="col col-12 col-lg-12 col-xl-7 py-5">
				The ESPARGOS controller takes care of distributing the firmware update to all sensor microcontrollers.
				<ul>
					<li>While the update is being distributed, the sensors will quickly alternate between green and red.</li>
					<li>In the end, the sensors will flash both red and green LEDs simultaneously to indicate that the update was succesful.</li>
				</ul>
			</div>
		</div>

		<h2>Recovery Instructions</h2>
		<div class="alert alert-info">Recovery images are only needed in case your ESPARGOS device is not functioning properly after a failed update. This way, you can always restore your device to a working state even if something goes wrong during the update process. You cannot "brick" ESPARGOS by due to firmware issues.</div>
		<p>
			<i>Recovery is only possible with the current hardware revision, prototype boards do not support this recovery method!</i>
		</p>
		<h4>Controller Firmware Recovery</h4>
		<p>
			<ul>
				<li>Make sure to install <a href="https://github.com/espressif/esptool">esptool</a>. It is included in <a href="https://github.com/espressif/esp-idf">ESP-IDF</a>, but full installation of ESP-IDF is not required.</li>
				<li>Connect ESPARGOS to your computer via USB. It will appear as a USB serial device, assumed to be named <code>/dev/ttyUSB0</code> in the following.</li>
				<li>Execute the following command to flash the recovery image. This will reset ESPARGOS to factory settings:</li>
				<pre class="m-0"><code class="language-bash" style="background: black;">esptool --chip esp32 -b 2000000 --before default-reset --after hard-reset write-flash --flash-mode dio --flash-size 16MB --flash-freq 40m 0x0000 espargos-controller-recovery.bin</code></pre>
			</ul>
		</p>

		<h4>Sensor Firmware Recovery</h4>
		<p>
			<ul>
				<li>Download the sensor recovery partition from the link above, and upload it to ESPARGOS using the web interface.</li>
				<li>Click the "Provision All Sensors" button on the web interface. Be very patient, this will take up to ten minutes.</li>
			</ul>
		</p>
	</div>
</main>